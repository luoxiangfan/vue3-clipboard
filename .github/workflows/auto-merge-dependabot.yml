name: Dependabot è‡ªåŠ¨åˆå¹¶
on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    
    steps:
      - name: ç­‰å¾…æ£€æŸ¥é€šè¿‡
        id: wait-and-check
        run: |
          # æœ€å¤§ç­‰å¾…æ—¶é—´
          max_wait=$((8 * 60))
          interval=30
          elapsed=0
          
          echo "â³ ç­‰å¾… CI æ£€æŸ¥å®Œæˆï¼ˆæœ€å¤š $((max_wait/60)) åˆ†é’Ÿï¼‰..."
          
          while [ $elapsed -lt $max_wait ]; do
            # è·å–æ£€æŸ¥çŠ¶æ€
            status=$(gh api \
              "/repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/status" \
              --jq '.state')
            
            if [ "$status" = "success" ]; then
              echo "âœ… æ‰€æœ‰æ£€æŸ¥å·²é€šè¿‡"
              echo "all_passed=true" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$status" = "failure" ]; then
              echo "âŒ æœ‰æ£€æŸ¥å¤±è´¥"
              exit 1
            elif [ "$status" = "pending" ]; then
              echo "â³ æ£€æŸ¥è¿›è¡Œä¸­... ç­‰å¾… $interval ç§’"
              sleep $interval
              elapsed=$((elapsed + interval))
            else
              echo "ğŸ“Š å½“å‰çŠ¶æ€: $status"
              sleep $interval
              elapsed=$((elapsed + interval))
            fi
          done
          
          echo "â° ç­‰å¾…è¶…æ—¶ï¼ˆ$((max_wait/60)) åˆ†é’Ÿï¼‰"
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è‡ªåŠ¨åˆå¹¶
        if: steps.wait-and-check.outputs.all_passed == 'true'
        run: |
          # ä½¿ç”¨ GitHub CLI åˆå¹¶
          gh pr merge ${{ github.event.pull_request.number }} \
            --auto \
            --squash \
            --subject "chore(deps): è‡ªåŠ¨åˆå¹¶ Dependabot æ›´æ–°"
          
          echo "âœ… PR å·²è‡ªåŠ¨åˆå¹¶"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}